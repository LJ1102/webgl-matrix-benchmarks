<!DOCTYPE html>

<html>
  <head>
    <title>Matrix Benchmark</title>
    
    <!-- Common Utilities -->
    <script type="text/javascript" src="sprintf.js"></script>
    <script type="text/javascript" src="js/rand.js"></script>

    <!-- Matrix Libraries -->
    <script type="text/javascript" src="js/glMatrix.js"></script>
    <script type="text/javascript" src="js/CanvasMatrix.js"></script>
    <script type="text/javascript" src="js/EWGL_math.js"></script>
    <script type="text/javascript" src="js/mjs.js"></script>
    <script type="text/javascript" src="js/tdl/base.js"></script>
    <script type="text/javascript" src="js/goog/base.js"></script>

    <!-- Graphing Utilities -->
    <link type="text/css" rel="stylesheet" href="flotr/flotr.css"/>
    <script type="text/javascript" src="flotr/lib/prototype.js"></script>
    <script type="text/javascript" src="flotr/lib/canvas2image.js"></script>
    <script type="text/javascript" src="flotr/lib/canvastext.js"></script>
    <script type="text/javascript" src="flotr/flotr.js"></script>
    
    <!-- Table Utilities -->
    <link type="text/css" rel="stylesheet" href="table/table.css"/>
    <script type="text/javascript" src="table/fastinit.js"></script>
    <script type="text/javascript" src="table/tablesort.js"></script>

    <!-- Benchmarking utilities -->
    <script type="text/javascript">
      tdl.require('tdl.math');
      tdl.require('tdl.fast');
      goog.require('goog.vec.Matrix4');
      goog.require('goog.vec.Matrix3');

      testData = {};
      testSets = [];
      testSetIndex = 0;

      function debuggerLog(obj) {
        if (window.console && window.console.log) {
          window.console.log(obj);
        }
      }
      
      function log(html) {
        document.getElementById('logDiv').innerHTML += html + '<br/><br/>'
      }
      
      function logTitle(title) {
        document.getElementById('logDiv').innerHTML += 
        '=============================================<br/>' +
        '<b>' + title + '</b><br/>' +
        '=============================================' + '<br/><br/>'
      }
      
      function test(library, f, dataLogger) {
        // Repeats each benchmark multiple times to smooth out anomalies
        // Also tracks min and max times
        
        if(!f) {
          log('<i>' + library + ': Unsupported</i>');
          dataLogger[library] = { avg: null, min: null, max: null };
          return;
        }
        
        var runCount = 10;
        var internalRunCount = 50000;
        var totalTime = 0;
        var minTime = 0;
        var maxTime = 0;
        resetPseudoRandom();

        for(var i = 0; i < runCount; ++i) {
          var data = f(internalRunCount);
          var time = data.time;
          if(i == 0) {
            minTime = time;
            maxTime = time;
          } else {
            if(minTime > time) { minTime = time; }
            if(maxTime < time) { maxTime = time; }
          }
          totalTime += time;
        }
        
        var avg = totalTime / runCount;
        
        log('<i>' + library + '</i> - Avg: <b>' + avg + 'ms</b>, Min: ' + minTime + 'ms, Max: ' + maxTime + 'ms');
        
        dataLogger[library] = { avg: avg, min: minTime, max: maxTime };
        
        return data.result;
      }

      function preTest(library, f) {
        // Repeats each benchmark multiple times to smooth out anomalies
        // Also tracks min and max times

        if(!f) {
          return;
        }

        var internalRunCount = 5;
        resetPseudoRandom();

        var data = f(internalRunCount);
        return data.result;
      }

      // Adds a test
      function testSet(name, tests) {
        testData[name] = {};
        testSets.push({name: name, tests: tests});
      }

      function runTestSet(name, tests) {
        setTimeout(function() {
          logTitle(name);
          var results = [];
          var baseResult = null;
          for(var i = 0; i < tests.length; ++i) {
            var result = preTest(tests[i].library, tests[i].test);
            results.push(result);
            if (!baseResult && result) {
              baseResult= result;
            }
            test(tests[i].library, tests[i].test, testData[name]);
          }

          // Compare the results to make sure we are testing the same thing
          for (var i = 0; i < results.length; ++i) {
            if (results[i] && !Compare(baseResult, results[i])) {
              debuggerLog(name);
              debuggerLog(tests[i].library);
              debuggerLog(baseResult);
              debuggerLog(results[i]);
              log('<strong>' + tests[i].library + ': results do NOT match!!!</strong>');
              testData[name][tests[i].library].bad = true;
            }
          }
          plotBenchmarks(); 
          updateTableData(); 
          setTimeout(function() { 
            runNextTest();
          }, 100);
        }, 1);
      }

      function runNextTest() {
        if (testSetIndex < testSets.length) {
          var set = testSets[testSetIndex++];
          runTestSet(set.name, set.tests);
        }
      }
      
      var kEpsilon = 0.001;
      function Compare(a, b, pre) {
        if (b.m11) {
          b = [
            b.m11, b.m12, b.m13, b.m14,
            b.m21, b.m22, b.m23, b.m24,
            b.m31, b.m32, b.m33, b.m34,
            b.m41, b.m42, b.m43, b.m44
          ];
        } else if (b.elements) {
          b = b.elements;
        }
        return CompareInner(a, b, '');

        function CompareInner(a, b, pre) {
          // Check if array.
          if (typeof(a) === 'number') {
            if (typeof(b) !== 'number') {
              return false;
            }
            var diff =Math.abs(a - b);
            if (diff > kEpsilon) {
              log('<strong>Mismatch: ' + pre + ' ' + a + ' != ' + b + ' diff = ' + diff + '</strong>');
              return false;
            }
          } else if (a.length) {
            if (a.length !== b.length) return false;
            for (var i = 0; i < a.length; ++i) {
              if (!Compare(a[i], b[i], pre + '[' + i.toString() + ']')) return false
            }
          } else for (var key in a) {
            if (!Compare(a[key], b[key], pre + '[' + key + ']')) return false;
          }
          return true;
        }
      }

      function radToDeg(angleInRadians) {
        return angleInRadians * 180 / Math.PI;
      }

      function glMatrixRandom() {
        var m = mat4.create();
        var axis = vec3.normalize(vec3.create([pseudoRandom(), pseudoRandom(), pseudoRandom()]));
        mat4.identity(m);
        mat4.rotate(m, pseudoRandom(), axis, m);
        mat4.translate(m, [pseudoRandom(), pseudoRandom(), pseudoRandom()]);
        return m;
      }

      function mjsRandom() {
        var axis = V3.normalize([pseudoRandom(), pseudoRandom(), pseudoRandom()]);
        var m = M4x4.makeRotate(pseudoRandom(), axis);
        var m = M4x4.translate([pseudoRandom(), pseudoRandom(), pseudoRandom()], m);
        return m;
      }

      function canvasMatrixRandom() {
        var m =  new CanvasMatrix4()
        var axis = V3.normalize([pseudoRandom(), pseudoRandom(), pseudoRandom()]);
        var angle = radToDeg(pseudoRandom());
        var trans = [pseudoRandom(), pseudoRandom(), pseudoRandom()];
        m.translate(trans[0], trans[1], trans[2]);
        m.rotate(angle, axis[0], axis[1], axis[2]);
        return m;
      }

      function ewglMatrixRandom() {
        var m = new m4x4;
        var axis = (new v3([pseudoRandom(), pseudoRandom(), pseudoRandom()])).normalize();
        m.rotate(pseudoRandom(), axis);
        m.translate(new v3([pseudoRandom(), pseudoRandom(), pseudoRandom()]));
        return m;
      }

      function tdlMathMatrixRandom() {
        var m = tdl.math.matrix4.identity();
        var axis = tdl.math.normalize([pseudoRandom(), pseudoRandom(), pseudoRandom()]);
        tdl.math.matrix4.axisRotate(m, axis, pseudoRandom());
        tdl.math.matrix4.translate(m, [pseudoRandom(), pseudoRandom(), pseudoRandom()]);
        return m;
      }

      function tdlFastMatrixRandom() {
        var m = new Float32Array(16);
        var axis = tdl.math.normalize([pseudoRandom(), pseudoRandom(), pseudoRandom()]);
        tdl.fast.matrix4.identity(m);
        tdl.fast.matrix4.axisRotate(m, axis, pseudoRandom());
        tdl.fast.matrix4.translate(m, [pseudoRandom(), pseudoRandom(), pseudoRandom()]);
        return m;
      }

      function closureMatrixRandom() {
        var m = goog.vec.Matrix4.createIdentity();
        var axis = goog.vec.Vec3.createFromArray([pseudoRandom(), pseudoRandom(), pseudoRandom()]);
        goog.vec.Vec3.normalize(axis, axis);
        goog.vec.Matrix4.applyRotate(m, pseudoRandom(), axis[0], axis[1], axis[2]);
        goog.vec.Matrix4.applyTranslate(m, pseudoRandom(), pseudoRandom(), pseudoRandom());
        return m;
      }
    </script>
    
    
    <style type="text/css">
      body {
        font: 0.8em Verdana,sans-serif;
      }
      strong {
        color: red;
      }
    </style>
  </head>
  <body>
    <p>
      This page benchmarks the performance of several matrix libraries intended for use with WebGL: 
      <a href="http://code.google.com/p/glmatrix/">glMatrix</a>, <a href="http://code.google.com/p/webgl-mjs/">mjs</a>, 
      CanvasMatrix, <a href="http://code.google.com/p/ewgl-matrices/">EWGL_math</a>,  
      <a href="http://code.google.com/p/threedlibrary/">tdl</a>, and 
      <a href="http://closure-library.googlecode.com/">Google's Closure</a>.<br/>
      Benchmark times are averaged over 10 runs of 50,000 iterations of the target operation.<br/>
    </p>
    <div id="graph" style="width:800px;height:400px;margin:10px"></div>
    <div id="tablediv" style="font-size:85%;width:800px;margin:10px">
      <table id='data-table' class='sortable'>
        <thead id="data-table-head">
          <tr></tr>
        </thead>
        <tbody id="data-table-body"></tbody>
      </table>
    </div>
    <p><em>
      Adapted from the benchmarks Brandon Jones created in his <a href=" https://glmatrix.googlecode.com/hg/">glmatrix library</a>.<br/>
      JavaScript Plotting library: <a href=" http://solutoire.com/flotr/">Flotr</a>; 
      <a href="http://tetlaw.id.au/view/blog/table-sorting-with-prototype/">Sortable Table</a> by Andrew Tetlaw.<br/>
      The source code for these benchmarks can be found here on <a href="https://github.com/stepheneb/webgl-matrix-benchmarks">github</a>.
    </em></p>
    <br/><br/>
    <div id="logDiv"></div>

    <!-- Benchmarks -->
    <script type="text/javascript">
      function testMain() {
        
        testSet('Multiplication', [
          { library: 'glMatrix', test: function(count) {
            var m1 = glMatrixRandom();
            var m2 = glMatrixRandom();
            var start = Date.now();
            for (var i = 0; i < count; ++i) {
              mat4.multiply(m1, m2);
            }
            return {time: Date.now()-start, result: m1};
          }},
          { library: 'mjs', test: function(count) {
            var m1 = mjsRandom();
            var m2 = mjsRandom();
            var start = Date.now();
            for (var i = 0; i < count; ++i) {
              M4x4.mul(m1, m2, m1);
            }
            return {time: Date.now()-start, result: m1};
          }},
          { library: 'CanvasMatrix', test: function(count) {
            var m1 = canvasMatrixRandom();
            var m2 = canvasMatrixRandom();
            var start = Date.now();
            for (var i = 0; i < count; ++i) {
              m1.multLeft(m2);
            }
            return {time: Date.now()-start, result: m1};
          }},
          { library: 'EWGL', test: function(count) {
            var m1 = ewglMatrixRandom();
            var m2 = ewglMatrixRandom();
            var start = Date.now();
            for (var i = 0; i < count; ++i) {
              m1.x(m2);
            }
            return {time:Date.now()-start, result: m1};
          }},
          { library: 'TDLMath', test: function(count) {
            var m1 = tdlMathMatrixRandom();
            var m2 = tdlMathMatrixRandom();
            var mat4 = tdl.math.matrix4;
            var start = Date.now();
            for (var i = 0; i < count; ++i) {
              m1 = mat4.mul(m2, m1);
            }
            return {time:Date.now()-start, result: m1};
          }},
          { library: 'TDLFast', test: function(count) {
            var m1 = tdlFastMatrixRandom();
            var m2 = tdlFastMatrixRandom();
            var mat4 = tdl.fast.matrix4;
            var start = Date.now();
            for (var i = 0; i < count; ++i) {
              mat4.mul(m1, m2, m1);
            }
            return {time:Date.now()-start, result: m1};
          }},
          { library: 'closure', test: function(count) {
            var m1 = closureMatrixRandom();
            var m2 = closureMatrixRandom();
            var mat4 = goog.vec.Matrix4;
            var start = Date.now();
            for (var i = 0; i < count; ++i) {
              mat4.multMat(m1, m2, m1);
            }
            return {time:Date.now()-start, result: m1};
          }}
        ]);

        testSet('Translation', [
          { library: 'glMatrix', test: function(count) {
            var m1 = glMatrixRandom();
            var v1 = vec3.create([1, 2, 3]);
            var start = Date.now();
            for (var i = 0; i < count; ++i) {
              mat4.translate(m1, v1);
            }
            return {time:Date.now()-start, result: m1};
          }},
          { library: 'mjs', test: function(count) {
            var m1 = mjsRandom();
            var v1 = V3.$(1, 2, 3);
            var start = Date.now();
            for (var i = 0; i < count; ++i) {
              M4x4.translate(v1, m1, m1);
            }
            return {time:Date.now()-start, result: m1};
          }},
          { library: 'CanvasMatrix', test: function(count) {
            var m1 = new CanvasMatrix4();
            var m2 = canvasMatrixRandom();
            var start = Date.now();
            for (var i = 0; i < count; ++i) {
              m1.translate(1, 2, 3);
            }
            m1.multRight(m2);
            return {time:Date.now()-start, result: m1};
          }},
          { library: 'EWGL', test: function(count) {
            var m1 = ewglMatrixRandom();
            var v1 = new v3([1, 2, 3]);
            var start = Date.now();
            for (var i = 0; i < count; ++i) {
              m1.translate(v1);
            }
            return {time:Date.now()-start, result: m1};
          }},
          { library: 'TDLMath', test: function(count) {
            var m1 = tdlMathMatrixRandom();
            var v1 = [1, 2, 3];
            var start = Date.now();
            var mat4 = tdl.math.matrix4;
            for (var i = 0; i < count; ++i) {
              mat4.translate(m1, v1);
            }
            return {time:Date.now()-start, result: m1};
          }},
          { library: 'TDLFast', test: function(count) {
            var m1 = tdlMathMatrixRandom();
            var v1 = new Float32Array([1, 2, 3]);
            var start = Date.now();
            var mat4 = tdl.fast.matrix4;
            for (var i = 0; i < count; ++i) {
              mat4.translate(m1, v1);
            }
            return {time:Date.now()-start, result: m1};
          }},
          { library: 'closure', test: function(count) {
            var m1 = closureMatrixRandom();
            var v1 = goog.vec.Vec3.createFromValues(1, 2, 3);
            var mat4 = goog.vec.Matrix4;
            var start = Date.now();
            for (var i = 0; i < count; ++i) {
              mat4.applyTranslate(m1, v1[0], v1[1], v1[2]);
            }
            return {time:Date.now()-start, result: m1};
          }}
        ]);

        testSet('Scaling', [
          { library: 'glMatrix', test: function(count) {
            var m1 = glMatrixRandom();
            var v1 = vec3.create([1, 2, 3]);
            var start = Date.now();
            for (var i = 0; i < count; ++i) {
              mat4.scale(m1, v1);
            }
            return {time:Date.now()-start, result: m1};
          }},
          { library: 'mjs', test: function(count) {
            var m1 = mjsRandom();
            var v1 = V3.$(1, 2, 3);
            var start = Date.now();
            for (var i = 0; i < count; ++i) {
              M4x4.scale(v1, m1, m1);
            }
            return {time:Date.now()-start, result: m1};
          }},
          { library: 'CanvasMatrix', test: function(count) {
            var m1 = new CanvasMatrix4();
            var m2 = canvasMatrixRandom();
            var start = Date.now();
            for (var i = 0; i < count; ++i) {
              m1.scale(1, 2, 3);
            }
            m1.multRight(m2);
            return {time:Date.now()-start, result: m1};
          }},
          { library: 'EWGL', test: function(count) {
            var m1 = ewglMatrixRandom();
            var v1 = new v3([1, 2, 3]);
            var start = Date.now();
            for (var i = 0; i < count; ++i) {
              m1.scale(v1);
            }
            return {time:Date.now()-start, result: m1};
          }},
          { library: 'TDLMath', test: function(count) {
            var m1 = tdlMathMatrixRandom();
            var v1 = [1, 2, 3];
            var start = Date.now();
            var mat4 = tdl.math.matrix4;
            for (var i = 0; i < count; ++i) {
              mat4.scale(m1, v1);
            }
            return {time:Date.now()-start, result: m1};
          }},
          { library: 'TDLFast', test: function(count) {
            var m1 = tdlMathMatrixRandom();
            var v1 = new Float32Array([1, 2, 3]);
            var start = Date.now();
            var mat4 = tdl.fast.matrix4;
            for (var i = 0; i < count; ++i) {
              mat4.scale(m1, v1);
            }
            return {time:Date.now()-start, result: m1};
          }},
          { library: 'closure', test: function(count) {
            var m1 = closureMatrixRandom();
            var v1 = goog.vec.Vec3.createFromValues(1, 2, 3);
            var mat4 = goog.vec.Matrix4;
            var start = Date.now();
            for (var i = 0; i < count; ++i) {
              mat4.applyScale(m1, v1[0], v1[1], v1[2]);
            }
            return {time:Date.now()-start, result: m1};
          }}
        ]);

        testSet('Rotation (Arbitrary axis)', [
          { library: 'glMatrix', test: function(count) {
            var m1 = glMatrixRandom();
            var v1 = vec3.create([1, 2, 3]);
            var a = Math.PI/2;
            var start = Date.now();
            for (var i = 0; i < count; ++i) {
              mat4.rotate(m1, a, v1);
            }
            return {time:Date.now()-start, result: m1};
          }},
          { library: 'mjs', test: function(count) {
            var m1 = mjsRandom();
            var v1 = V3.$(1, 2, 3);
            var a = Math.PI/2;
            var start = Date.now();
            for (var i = 0; i < count; ++i) {
              M4x4.rotate(a, v1, m1, m1);
            }
            return {time:Date.now()-start, result: m1};
          }},
          { library: 'CanvasMatrix', test: function(count) {
            var m1 = new CanvasMatrix4();
            var m2 = canvasMatrixRandom();
            var start = Date.now();
            for (var i = 0; i < count; ++i) {
              m1.rotate(90, 1, 2, 3);
            }
            m1.multRight(m2);
            return {time:Date.now()-start, result: m1};
          }},
          { library: 'EWGL', test: function(count) {
            var m1 = ewglMatrixRandom();
            var v1 = new v3([1, 2, 3]);
            var a = Math.PI/2;
            var start = Date.now();
            for (var i = 0; i < count; ++i) {
              m1.rotate(a, v1, m1);
            }
            return {time:Date.now()-start, result: m1};
          }},
          { library: 'TDLMath', test: function(count) {
            var m1 = tdlMathMatrixRandom();
            var v1 = tdl.math.normalize([1, 2, 3]);
            var mat4 = tdl.math.matrix4;
            var a = Math.PI/2;
            var start = Date.now();
            for (var i = 0; i < count; ++i) {
              mat4.axisRotate(m1, v1, a);
            }
            return {time:Date.now()-start, result: m1};
          }},
          { library: 'TDLFast', test: function(count) {
            var m1 = tdlMathMatrixRandom();
            var v1 = new Float32Array([1, 2, 3]);
            tdl.fast.normalize(v1, v1);
            var mat4 = tdl.fast.matrix4;
            var a = Math.PI/2;
            var start = Date.now();
            for (var i = 0; i < count; ++i) {
              mat4.axisRotate(m1, v1, a);
            }
            return {time:Date.now()-start, result: m1};
          }},
          { library: 'closure', test: function(count) {
            var m1 = closureMatrixRandom();
            var v1 = goog.vec.Vec3.createFromValues(1, 2, 3);
            goog.vec.Vec3.normalize(v1, v1);
            var mat4 = goog.vec.Matrix4;
            var a = Math.PI/2;
            var start = Date.now();
            for (var i = 0; i < count; ++i) {
              mat4.applyRotate(m1, a, v1[0], v1[1], v1[2]);
            }
            return {time:Date.now()-start, result: m1};
          }}
        ]);

        testSet('Rotation (X axis)', [
          { library: 'glMatrix', test: function(count) {
            var m1 = glMatrixRandom();
            var v1 = vec3.create([1, 0, 0]);
            var a = Math.PI/2;
            var start = Date.now();
            for (var i = 0; i < count; ++i) {
              mat4.rotate(m1, a, v1);
            }
            return {time:Date.now()-start, result: m1};
          }},
          { library: 'mjs', test: function(count) {
            var m1 = mjsRandom();
            var v1 = V3.$(1, 0, 0);
            var a = Math.PI/2;
            var start = Date.now();
            for (var i = 0; i < count; ++i) {
              M4x4.rotate(a, v1, m1, m1);
            }
            return {time:Date.now()-start, result: m1};
          }},
          { library: 'CanvasMatrix', test: function(count) {
            var m1 = new CanvasMatrix4();
            var m2 = canvasMatrixRandom();
            var start = Date.now();
            for (var i = 0; i < count; ++i) {
              m1.rotate(90, 1, 0, 0);
            }
            m1.multRight(m2);
            return {time:Date.now()-start, result: m1};
          }},
          { library: 'EWGL', test: function(count) {
            var m1 = ewglMatrixRandom();
            var v1 = new v3([1, 0, 0]);
            var a = Math.PI/2;
            var start = Date.now();
            for (var i = 0; i < count; ++i) {
              m1.rotate(a, v1);
            }
            return {time:Date.now()-start, result: m1};
          }},
          { library: 'TDLMath', test: function(count) {
            var m1 = tdlMathMatrixRandom();
            var a = Math.PI/2;
            var mat4 = tdl.math.matrix4;
            var start = Date.now();
            for (var i = 0; i < count; ++i) {
              mat4.rotateX(m1, a);
            }
            return {time:Date.now()-start, result: m1};
          }},
          { library: 'TDLFast', test: function(count) {
            var m1 = tdlMathMatrixRandom();
            var a = Math.PI/2;
            var mat4 = tdl.fast.matrix4;
            var start = Date.now();
            for (var i = 0; i < count; ++i) {
              mat4.rotateX(m1, a);
            }
            return {time:Date.now()-start, result: m1};
          }},
          { library: 'closure', test: function(count) {
            var m1 = closureMatrixRandom();
            var v1 = goog.vec.Vec3.createFromValues(1, 0, 0);
            var mat4 = goog.vec.Matrix4;
            var a = Math.PI/2;
            var start = Date.now();
            for (var i = 0; i < count; ++i) {
              mat4.applyRotate(m1, a, v1[0], v1[1], v1[2]);
            }
            return {time:Date.now()-start, result: m1};
          }}
        ]);

        testSet('Transpose', [
          { library: 'glMatrix', test: function(count) {
            var m1 = glMatrixRandom();
            var start = Date.now();
            for (var i = 0; i < count; ++i) {
              mat4.transpose(m1);
            }
            return {time:Date.now()-start, result: m1};
          }},
          { library: 'mjs', test: function(count) {
            var m1 = mjsRandom();
            var start = Date.now();
            for (var i = 0; i < count; ++i) {
              M4x4.transpose(m1, m1);
            }
            return {time:Date.now()-start, result: m1};
          }},
          { library: 'CanvasMatrix', test: function(count) {
            var m1 = canvasMatrixRandom();
            var start = Date.now();
            for (var i = 0; i < count; ++i) {
              m1.transpose();
            }
            return {time:Date.now()-start, result: m1};
          }},
          { library: 'EWGL', test: function(count) {
            var m1 = ewglMatrixRandom();
            var start = Date.now();
            for (var i = 0; i < count; ++i) {
              m1.transpose();
            }
            return {time:Date.now()-start, result: m1};
          }},
          { library: 'TDLMath', test: function(count) {
            var m1 = tdlMathMatrixRandom();
            var mat4 = tdl.math.matrix4;
            var start = Date.now();
            for (var i = 0; i < count; ++i) {
              m1 = mat4.transpose(m1);
            }
            return {time:Date.now()-start, result: m1};
          }},
          { library: 'TDLFast', test: function(count) {
            var m1 = tdlMathMatrixRandom();
            var mat4 = tdl.fast.matrix4;
            var start = Date.now();
            for (var i = 0; i < count; ++i) {
              mat4.transpose(m1, m1);
            }
            return {time:Date.now()-start, result: m1};
          }},
          { library: 'closure', test: function(count) {
            var m1 = closureMatrixRandom();
            var mat4 = goog.vec.Matrix4;
            var start = Date.now();
            for (var i = 0; i < count; ++i) {
              mat4.transpose(m1, m1);
            }
            return {time:Date.now()-start, result: m1};
          }}
        ]);

        testSet('Inverse', [
          { library: 'glMatrix', test: function(count) {
            var m1 = mat4.perspective(90, 0.5, 1, 1000);
            var start = Date.now();
            for (var i = 0; i < count; ++i) {
              mat4.inverse(m1);
            }
            return {time:Date.now()-start, result: m1};
          }},
          { library: 'mjs', test: function(count) {
           var m1 = M4x4.makePerspective(90, 0.5, 1, 1000);
           var start = Date.now();
           for (var i = 0; i < count; ++i) {
             M4x4.inverseOrthonormal(m1, m1);
           }
           return {time:Date.now()-start, result: m1};
          }},
          { library: 'CanvasMatrix', test: function(count) {
            var m1 = new CanvasMatrix4();
            m1.perspective(90, 0.5, 1, 1000);
            var start = Date.now();
            for (var i = 0; i < count; ++i) {
              m1.invert();
            }
            return {time:Date.now()-start, result: m1};
          }},
          { library: 'EWGL', test: function(count) {
            var m1 = m4x4.makePerspective(90, 0.5, 1, 1000);
            var start = Date.now();
            for (var i = 0; i < count; ++i) {
              m1.inverse();
            }
            return {time:Date.now()-start, result: m1};
          }},
          { library: 'TDLMath', test: function(count) {
            var mat4 = tdl.math.matrix4;
            var m1 = mat4.perspective(Math.PI/2, 0.5, 1, 1000);
            var start = Date.now();
            for (var i = 0; i < count; ++i) {
              m1 = mat4.inverse(m1);
            }
            return {time:Date.now()-start, result: m1};
          }},
          { library: 'TDLFast', test: function(count) {
            var m1 = tdlMathMatrixRandom();
            var mat4 = tdl.fast.matrix4;
            mat4.perspective(m1, Math.PI/2, 0.5, 1, 1000);
            var start = Date.now();
            for (var i = 0; i < count; ++i) {
              mat4.inverse(m1, m1);
            }
            return {time:Date.now()-start, result: m1};
          }},
          { library: 'closure', test: function(count) {
            var m1 = closureMatrixRandom();
            var mat4 = goog.vec.Matrix4;
            mat4.makePerspective(m1, Math.PI/2, 0.5, 1, 1000);
            var start = Date.now();
            for (var i = 0; i < count; ++i) {
              mat4.invert(m1, m1);
            }
            return {time:Date.now()-start, result: m1};
          }}
        ]);

        testSet('Inverse 3x3', [
          { library: 'glMatrix', test: function(count) {
            var m1 = glMatrixRandom();
            var res = mat3.create();
            var start = Date.now();
            for (var i = 0; i < count; ++i) {
              mat4.toInverseMat3(m1, res);
              mat3.toMat4(res, m1);
            }
            return {time:Date.now()-start, result: m1};
          }},
          { library: 'mjs', test: function(count) {
            var m1 = mjsRandom();
            var res = new MJS_FLOAT_ARRAY_TYPE(9);
            var start = Date.now();
            for (var i = 0; i < count; ++i) {
              M4x4.inverseTo3x3(m1, res);
              m1[0] = res[0];
              m1[1] = res[1];
              m1[2] = res[2];
              m1[3] = 0;
              m1[4] = res[3];
              m1[5] = res[4];
              m1[6] = res[5];
              m1[7] = 0;
              m1[8] = res[6];
              m1[9] = res[7];
              m1[10] = res[8];
              m1[11] = 0;
              m1[12] = 0;
              m1[13] = 0;
              m1[14] = 0;
              m1[15] = 1;              
            }
            return {time:Date.now()-start, result: m1};
          }},
          { library: 'CanvasMatrix', test: null },
          { library: 'EWGL', test: null },
          { library: 'TDLMath', test: function(count) {
            var m1 = tdl.math.matrix4.getUpper3x3(tdlMathMatrixRandom());
            var math = tdl.math;
            var start = Date.now();
            for (var i = 0; i < count; ++i) {
              m1 = math.inverse3(m1);
            }
            var m2 = tdl.math.matrix4.identity();
            tdl.math.matrix4.setUpper3x3(m2, m1);
            return {time:Date.now()-start, result: m2};
          }},
          { library: 'TDLFast', test: null},
          { library: 'closure', test: function(count) {
            var m1 = closureMatrixRandom();
            m1 = goog.vec.Matrix3.createFromValues(
                m1[0], m1[1], m1[2],
                m1[4], m1[5], m1[7],
                m1[8], m1[9], m1[10]);
            var mat3 = goog.vec.Matrix3;
            var start = Date.now();
            for (var i = 0; i < count; ++i) {
              mat3.invert(m1, m1);
            }
            var m2 = goog.vec.Matrix4.createFromValues(
                m1[0], m1[1], m1[2], 0,
                m1[3], m1[4], m1[5], 0,
                m1[6], m1[7], m1[8], 0,
                0, 0, 0, 1);
            return {time:Date.now()-start, result: m2};
          }},
        ]);

        testSet('Vector Transformation', [
          { library: 'glMatrix', test: null},
          { library: 'mjs', test: function(count) {
            var m1 = mjsRandom();
            var v1 = V3.$(1, 2, 3);
            var v2 = V3.$();
            var start = Date.now();
            for (var i = 0; i < count; ++i) {
              V3.mul4x4(m1, v1, v2);
              var t = v1;
              v1 = v2;
              v2 = t;
            }
            return {time:Date.now()-start, result: v1};
          }},
          { library: 'CanvasMatrix', test: null },
          { library: 'EWGL', test: null },
          { library: 'TDLMath', test: function(count) {
            var m1 = tdlMathMatrixRandom();
            var v1 = [1, 2, 3];
            var mat4 = tdl.math.matrix4;
            var start = Date.now();
            for (var i = 0; i < count; ++i) {
              v1 = mat4.transformPoint(m1, v1);
            }
            return {time:Date.now()-start, result: v1};
          }},
          { library: 'TDLFast', test: null },
          { library: 'closure', test: function(count) {
            var m1 = closureMatrixRandom();
            var v1 = goog.vec.Vec3.createFromValues(1, 2, 3);
            var mat4 = goog.vec.Matrix4;
            var start = Date.now();
            for (var i = 0; i < count; ++i) {
              mat4.multVec3Projective(m1, v1, v1);
            }
            return {time:Date.now()-start, result: v1};
          }},
        ]);

        runNextTest();
      };
      
      
      function plotBenchmarks() {
          var datasets = [];
          var benchmarks = [];
          var benchmarkIndex, libraryIndex;
          benchmarkIndex = 0;
          var x_axis_tics = [];
          var maxTime = 0;
          for (benchmark in testData) {
            benchmarks.push(benchmark);
            libraryIndex = 0;
            for (library in testData[benchmark]) {
              if (!datasets[libraryIndex]) {
                datasets.push({});
                datasets[libraryIndex]['data'] = [];
                datasets[libraryIndex]['label'] = library;
                datasets[libraryIndex]['lines'] = { show: true };
                datasets[libraryIndex]['points'] = { show: true };
              }
              var avg = testData[benchmark][library].avg;
              datasets[libraryIndex]['data'].push([benchmarkIndex, avg]);
              if (avg && avg > maxTime) {
                maxTime = avg;
              }
              libraryIndex++;
            }
            benchmarkIndex++;
          }
          for(i = 0; i < benchmarks.length; i++) {
            x_axis_tics.push([i, benchmarks[i]])
          }
          var f = Flotr.draw($('graph'), datasets, 
            {
              xaxis:{ 
                labelsAngle: 60, 
                ticks: x_axis_tics,
                title: 'Benchmark', 
                noTics: benchmarks.length,
                min: 0, max: benchmarks.length - 1,
              },
              yaxis:{ title: 'Time (ms)', min: 0, max: maxTime },
              title: "WebGL Matrix Library Benchmark",
              subtitle: "Averaged over 10 runs of 50,000 iterations.",
              grid:{ verticalLines: true, backgroundColor: 'white' },
              HtmlText: false,
              legend: { position: 'nw' },
              mouse:{
                track: true,
                lineColor: 'purple',
                relative: true,
                position: 'nw',
                sensibility: 1, // => The smaller this value, the more precise you've to point
                trackDecimals: 1,
                trackFormatter: function(obj) { 
                  return obj.series.label + ':' + benchmarks[Number(obj.x)] +  ', ' + obj.y + 'ms'
                }
              },
              crosshair:{ mode: 'xy' }
            }
          );
      };
      
      var data_table_head = document.getElementById("data-table-head");
      var data_table_body = document.getElementById("data-table-body");

      var libraries = ["glMatrix", "mjs", "CanvasMatrix", "EWGL", "TDLMath",  "TDLFast", "closure"];
      
      function library_to_id(library) {
        return library.toLowerCase().replace(/\W/g, '_');
      }

      function createTableData() {
          var row, data, header;
          row = document.createElement('tr');
          header = document.createElement('th');
          header.className = "text sortcol";
          header.textContent = "Library";
          row.appendChild(header);
          for(benchmark in testData) {
            header = document.createElement('th');
            header.className = "number sortcol";
            header.textContent = benchmark;
            row.appendChild(header);
          };
          header = document.createElement('th');
          header.className = "number sortcol sortfirstasc";
          header.textContent = "Average";
          row.appendChild(header);
          data_table_head.deleteRow(0)
          data_table_head.appendChild(row);
          
          for (i = 0; i < libraries.length; i++) {
            row = document.createElement('tr');
            row.id = libraries[i] + '_row';
            data = document.createElement('td');
            data.textContent = libraries[i];
            row.appendChild(data);
            for(benchmark in testData) {
              data = document.createElement('td');
              data.id = benchmark + '_' + library_to_id(libraries[i]) + '_data'
              data.textContent = "";
              row.appendChild(data);
            };
            data = document.createElement('td');
            data.id = library_to_id(libraries[i]) + '_ave__data'
            data.textContent = "";
            row.appendChild(data);
            data_table_body.appendChild(row);
         };
      };

      var  averages = {};

      function updateTableData() {
        var row, data, value, average;
        for(benchmark in testData) {
          for (library in testData[benchmark]) {
            data = document.getElementById(benchmark + '_' + library_to_id(library) + '_data');
            value = testData[benchmark][library].avg;
            data.textContent = value;
            if (testData[benchmark][library].bad) {
              data.textContent += "(bad)";
            }
            average = averages[library];
            if (typeof(average) === "number" && typeof(value) === "number") {
               averages[library] = (average + value) / 2;
            } else {
               averages[library] = value;
            }
          };
        };
        for (library in averages) {
          if (averages[library]) {
            data = document.getElementById(library_to_id(library) + '_ave__data');
            data.textContent = sprintf("%3.1f", averages[library]);
          };
        };
        SortableTable.load();
      };
      
    </script>
    <script type="text/javascript">
     window.onload=function() {
       testMain();
       plotBenchmarks();
       createTableData();
       setTimeout(function() { plotBenchmarks() }, 1);
      }
    </script>
  </body>
</html>